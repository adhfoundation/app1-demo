import { NextResponse } from "next/server";

export async function GET() {
  const script = `(function(){function g(){const a=new Uint8Array(64);crypto.getRandomValues(a);return btoa(String.fromCharCode(...a)).replace(/\\+/g,"-").replace(/\\//g,"_").replace(/=/g,"")}async function c(v){const d=new TextEncoder().encode(v),h=await crypto.subtle.digest("SHA-256",d);return btoa(String.fromCharCode(...new Uint8Array(h))).replace(/\\+/g,"-").replace(/\\//g,"_").replace(/=/g,"")}function i(){document.querySelectorAll('#afya-sso-iframe').forEach(function(e){const t=e.getAttribute('data-client-id')||'i9kz2u01dpu2t1n0eh388',s=e.getAttribute('data-scopes')||'openid profile email offline_access',m=e.getAttribute('data-mode')||'login',w=e.getAttribute('data-width')||'100%',h=e.getAttribute('data-height')||'600px',a='https://identity-api.develop.afya.systems/auth/authorize',u='https://identity-api.develop.afya.systems/auth/token',o=window.location.origin,r=o+'/callback/iframe';let v=null,n=null;async function p(){try{v=g();localStorage.setItem('pkce_verifier',v);const l=await c(v),f=new URLSearchParams({client_id:t,redirect_uri:r,response_type:'code',scope:s,state:'iframe-auth',code_challenge:l,code_challenge_method:'S256',prompt:m==='login'?'login':'none'});e.innerHTML='';n=document.createElement('iframe');n.src=a+'?'+f.toString();n.style.cssText='width:'+w+';height:'+h+';border:none;border-radius:8px;overflow:hidden';n.title='SSO Login Iframe';n.sandbox='allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation-by-user-activation';n.scrolling='no';e.appendChild(n)}catch(l){e.innerHTML='<div style="padding:20px;color:#dc2626">Erro ao iniciar</div>'}}function x(l){const f=window.location.origin;if(!([f,'http://localhost:3000','https://localhost:3000','https://identity-api.develop.afya.systems'].some(d=>l.origin.startsWith(d))||l.origin.includes('ngrok')||l.origin===f))return;if(l.data?.type==='oauth-callback'&&l.data?.code)q(l.data.code);if(l.data?.type==='oauth-error')e.innerHTML='<div style="padding:20px;color:#dc2626">Erro: '+(l.data.error||'Erro')+'</div>'}async function q(f){const y=v||localStorage.getItem('pkce_verifier');if(!y){e.innerHTML='<div style="padding:20px;color:#dc2626">Erro: verifier não encontrado</div>';return}try{const b=await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({grant_type:'authorization_code',client_id:t,redirect_uri:r,code:f,code_verifier:y})});if(!b.ok){e.innerHTML='<div style="padding:20px;color:#dc2626">Erro ao obter tokens</div>';return}const d=await b.json();if(d.access_token)localStorage.setItem('access_token',d.access_token);if(d.id_token)localStorage.setItem('id_token',d.id_token);if(d.refresh_token)localStorage.setItem('refresh_token',d.refresh_token);if(n){n.style.transition='opacity 0.3s';n.style.opacity='0';setTimeout(()=>{e.innerHTML='<div style="padding:20px;color:#059669;text-align:center">✓ Sucesso!</div>';window.dispatchEvent(new CustomEvent('afya-sso-success',{detail:{tokens:d}}))},300)}}catch(d){e.innerHTML='<div style="padding:20px;color:#dc2626">Erro</div>'}}window.addEventListener('message',x);if(m==='login'){const l=localStorage.getItem('access_token');if(!l)p();else e.innerHTML='<div style="padding:20px;color:#059669;text-align:center">✓ Autenticado</div>'}e.startAuth=p})}if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',i);else i();window.addEventListener('load',i)})();`;

  return new NextResponse(script, {
    headers: {
      'Content-Type': 'application/javascript',
      'Cache-Control': 'public, max-age=3600',
    },
  });
}
